#!/usr/bin/env bash

set -euo pipefail

# Version regex pattern (used for validation and matching)
# MAJOR.MINOR.PATCH with optional +metadata (alphanumerics, dots, hyphens, underscores)
VERSION_PATTERN='^[0-9]+\.[0-9]+\.[0-9]+(\+[A-Za-z0-9._-]+)?$'

# Parse command-line options
FORCE_MAJOR=false
while getopts "f" opt; do
  case "$opt" in
    f)
      FORCE_MAJOR=true
      ;;
    *)
      echo "Usage: xarpite-update [-f]" >&2
      echo "  -f  Allow major version updates" >&2
      exit 1
      ;;
  esac
done

error() {
  echo "$1" >&2
  exit 1
}

check() {
  command -v "$1" > /dev/null 2>&1 || error "Error: $1 is required but not installed."
}
check curl
check tar
check perl
check sort
check rsync
check readlink
check mktemp

cd -- "$(dirname -- "$(readlink -f -- "$0")")"

# Setup temporary directory with cleanup trap
tmpdir=""
cleanup() {
  if [ -n "$tmpdir" ] && [ -d "$tmpdir" ]; then
    echo "Cleaning up temporary files" >&2
    rm -rf "$tmpdir" || true
  fi
}

on_exit() {
  exit_code=$?
  cleanup
  exit "$exit_code"
}

on_int() {
  cleanup
  exit 130  # 128 + SIGINT
}

on_term() {
  cleanup
  exit 143  # 128 + SIGTERM
}

trap on_exit EXIT
trap on_int INT
trap on_term TERM


# Determine the downloading version

# Get current version
VERSION_FILE="$(pwd)/version"
[ -f "$VERSION_FILE" ] || error "Error: version file not found: $VERSION_FILE"
current_version="$(cat "$VERSION_FILE")"
[ -z "$current_version" ] && error "Error: Failed to determine current version."

# Validate version format (basic semver check)
# Allow MAJOR.MINOR.PATCH with optional +metadata (alphanumerics, dots, hyphens, underscores)
if ! echo "$current_version" | grep -qE "$VERSION_PATTERN"; then
  error "Error: Invalid version format in version file: $current_version"
fi

echo "Current version: $current_version"

# Extract current major version (everything before first dot)
current_major="${current_version%%.*}"

echo "Fetching metadata"

export metadata=$(curl -s 'https://repo1.maven.org/maven2/io/github/mirrgieriana/xarpite-bin/maven-metadata.xml')

# Get all available versions
all_versions=$(
  perl -E '
    $ENV{metadata} =~ /<versions>(.*?)<\/versions>/s or die;
    my $versions = $1;
    while ($versions =~ /<version>(\d+\.\d+\.\d+(?:\+[^<]*)?)<\/version>/g) {
        say $1;
    }
  ' | sort -Vr
)

# Check if metadata parsing succeeded
if [ -z "$all_versions" ]; then
  error "Error: Failed to retrieve or parse version metadata. Please check your internet connection and try again."
fi

# Filter versions based on -f flag
if [ "$FORCE_MAJOR" = false ]; then
  # Only consider versions that start with current major version
  filtered_versions=$(echo "$all_versions" | grep "^$current_major\." || true)
  
  # Check if no matching versions found
  if [ -z "$filtered_versions" ]; then
    echo "Warning: No versions available for major version $current_major" >&2
    echo "         All available versions have a different major version" >&2
    echo "         Use -f flag to allow updating to a different major version" >&2
    error "Error: No suitable version found."
  fi
  
  # Check if there are major updates available
  latest_overall=$(echo "$all_versions" | head -n 1)
  if ! echo "$latest_overall" | grep -q "^$current_major\."; then
    echo "Note: Major version update available: $latest_overall" >&2
    echo "      Use -f flag to update to major versions" >&2
    echo >&2
  fi
else
  filtered_versions="$all_versions"
fi

version=$(echo "$filtered_versions" | head -n 1)
[ -z "$version" ] && error "Error: No suitable version found."

# Check if already up-to-date
if [ "$version" = "$current_version" ]; then
  echo "Already up-to-date: $version"
  exit 0
fi

echo "Target version: $version"

echo


# Download and extract

CLASSIFIER_FILE="$(pwd)/classifier"
[ -f "$CLASSIFIER_FILE" ] || error "Error: classifier file not found: $CLASSIFIER_FILE"
CLASSIFIER="$(cat "$CLASSIFIER_FILE")"
[ -z "$CLASSIFIER" ] && error "Error: Failed to determine classifier."

file="xarpite-bin-$version-$CLASSIFIER.tar.gz"
tmpdir=$(mktemp -d "/tmp/xarpite-update.XXXXXX") || error "Error: Failed to create temporary directory."
url="https://repo1.maven.org/maven2/io/github/mirrgieriana/xarpite-bin/$version/$file"

echo "Downloading from: $url"

curl -L -o - "$url" | tar -xzf - -C "$tmpdir"
echo "Successfully downloaded and extracted to: $tmpdir"

echo


# Update

echo "Updating"

echo "--- Dry run (no changes) ---"
rsync -n --itemize-changes -ac --delete "$tmpdir"/ ./
echo
printf "Type Y to apply (otherwise cancel): " >&2
read -r answer
echo
case "$answer" in
  [Yy]*)
    ;;
  *)
    error "Cancelled."
    ;;
esac
echo "Syncing"
rsync -ac --delete "$tmpdir"/ ./

echo


echo "Successfully Updated"
