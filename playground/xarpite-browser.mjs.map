{"version":3,"sources":["../../../../../../src/jsMain/kotlin/mirrg/xarpite/js/browser/JsBrowserMain.kt","../../../../../../src/jsMain/kotlin/mirrg/xarpite/js/browser/JsBrowserMounts.kt"],"sourcesContent":["package mirrg.xarpite.js.browser\n\nimport kotlinx.coroutines.CoroutineScope\nimport kotlinx.coroutines.SupervisorJob\nimport kotlinx.coroutines.await\nimport kotlinx.coroutines.cancel\nimport kotlinx.coroutines.promise\nimport mirrg.xarpite.Evaluator\nimport mirrg.xarpite.compilers.objects.FluoriteStream\nimport mirrg.xarpite.compilers.objects.FluoriteValue\nimport mirrg.xarpite.compilers.objects.cache\nimport mirrg.xarpite.compilers.objects.collect\nimport mirrg.xarpite.compilers.objects.toFluoriteString\nimport mirrg.xarpite.js.createJsMounts\nimport mirrg.xarpite.js.scope\nimport mirrg.xarpite.mounts.createCommonMounts\nimport kotlin.js.Promise\n\n@OptIn(ExperimentalJsExport::class)\n@JsExport\nfun evaluate(src: String, quiet: Boolean, out: (dynamic) -> Promise<Unit>): Promise<dynamic> = scope.promise {\n    val evaluator = Evaluator()\n    val daemonScope = CoroutineScope(coroutineContext + SupervisorJob())\n    try {\n        val defaultBuiltinMounts = listOf(\n            createCommonMounts(scope, daemonScope) { out(it).await() },\n            createJsMounts(),\n            createJsBrowserMounts(),\n        ).flatten()\n        evaluator.defineMounts(defaultBuiltinMounts)\n        if (quiet) {\n            evaluator.run(src)\n            undefined\n        } else {\n            evaluator.get(src).cache()\n        }\n    } finally {\n        daemonScope.cancel()\n    }\n}\n\n@OptIn(ExperimentalJsExport::class)\n@JsExport\nfun log(value: dynamic): Promise<Unit> = scope.promise {\n    val value = value.unsafeCast<FluoriteValue>()\n    if (value is FluoriteStream) {\n        value.collect {\n            console.log(it)\n        }\n    } else {\n        console.log(value)\n    }\n}\n\n@OptIn(ExperimentalJsExport::class)\n@JsExport\nfun stringify(value: dynamic): Promise<String> = scope.promise {\n    val value = value.unsafeCast<FluoriteValue>()\n    suspend fun f(value: FluoriteValue): String {\n        return if (value is FluoriteStream) {\n            val sb = StringBuilder()\n            var isFirst = true\n            value.collect {\n                if (isFirst) {\n                    isFirst = false\n                } else {\n                    sb.append('\\n')\n                }\n                sb.append(f(it))\n            }\n            sb.toString()\n        } else {\n            value.toFluoriteString().value\n        }\n    }\n    f(value)\n}\n","package mirrg.xarpite.js.browser\n\nimport kotlinx.browser.window\nimport mirrg.xarpite.compilers.objects.FluoriteNull\nimport mirrg.xarpite.compilers.objects.FluoriteValue\nimport mirrg.xarpite.js.FluoriteJsObject\n\nfun createJsBrowserMounts(): List<Map<String, FluoriteValue>> {\n    return mapOf(\n        \"WINDOW\" to try {\n            FluoriteJsObject(window)\n        } catch (_: Throwable) { // \u30c6\u30b9\u30c8\u74b0\u5883\u3067\u306f\u5229\u7528\u3067\u304d\u306a\u3044\n            FluoriteNull\n        },\n    ).let { listOf(it) }\n}\n"],"ignoreList":[],"x_google_ignoreList":[],"names":["evaluate","src","quiet","out","log","value","stringify","$out","invoke","$completion","doResume","evaluate$slambda$slambda","evaluate$slambda$slambda$lambda","$quiet","$src","t","evaluate$slambda","evaluate$slambda$lambda","log$slambda$slambda","log$slambda$slambda$lambda","$value","log$slambda","log$slambda$lambda","invoke$f","$isFirst","$sb","stringify$slambda$f$slambda","stringify$slambda$f$slambda$lambda","stringify$slambda","stringify$slambda$lambda","createJsBrowserMounts","<unused var>"],"mappings":"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"}