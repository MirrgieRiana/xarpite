---
title: "数値"
---

# 数値

Xarpiteは数値の扱いをサポートしています。

<!-- toc -->

## 概要

### 数値を表す型

数値を表す型には32ビット整数 `INT` と64ビット浮動小数点数 `DOUBLE` があります。

### 数値を意味する文字列との区別

Xarpiteでは数値と数値を意味する文字列は厳格に区別され、演算子や関数の挙動に違いを与えます。

```shell
$ xa '123 + 1'
# 124

$ xa '"123" + 1'
# 1231
```

---

数値を文字列にするには文字列化演算子 `&value` を使います。

その逆は数値化演算子 `+value` です。

```shell
$ xa '&123 + 1'
# 1231

$ xa '+"123" + 1'
# 124
```

## 数値リテラル

### `123`: 整数リテラル

1個以上の数字の列は整数リテラルになります。

```shell
$ xa '123'
# 123
```

---

0で始まる数字列であっても常に10進数として解釈されます。

```shell
$ xa '00123'
# 123
```

### `H#123abc`: 16進整数リテラル

`H#` に続いて16進数を書くことができます。

`H#` の部分は大文字でなければなりませんが、16進数の部分は大文字小文字を区別しません。

```shell
$ xa 'H#FF'
# 255
```

### `1.23`: 浮動小数点数リテラル

実数を「整数部 `.` 小数部」の形で書くことができます。

実数値の表現や演算には計算誤差が含まれます。

```shell
$ xa '1.5'
# 1.5
```

## 数値化

値を数値に変換する演算子と関数があります。

値の型によって数値化の挙動は異なります。

| 値のタイプ | 数値化の結果           |
|-------|------------------|
| NULL  | 0                |
| 数値    | その数値自身           |
| 論理値   | TRUEなら1、FALSEなら0 |
| 文字列   | 数値としてパースした結果     |
| ストリーム | 各要素の合計           |

### `+value`: 数値化

前置 `+` 演算子は値の数値化を行います。

主な用途は、文字列として表現されている数値データを内部的な数値に変換することです。

```shell
$ xa ' "+123"'
# +123

$ xa '+"+123"'
# 123
```

---

数値化は、値の `+_` メソッドを参照します。

オブジェクトの `+_` メソッドをオーバーライドすることで、数値化の処理を変更することができます。

```shell
$ xa '+{`+_`: this -> this.value * 2}{value: 100}'
# 200
```

### `-value`: 負の数値化

前置 `-` 演算子は数値化演算子と似ていますが、その値を負にします。

この演算子は「任意の値を数値に変換する処理」と「数値を負にする処理」を同時に行います。

```shell
$ xa '-"123"'
# -123

$ xa '-(100 + 20 + 3)'
# -123
```

### `TO_NUMBER`: 数値化

`TO_NUMBER(value: VALUE): NUMBER`

値を数値に変換します。

`+value` 演算子と同じ動作をします。

```shell
$ xa 'TO_NUMBER("123")'
# 123

$ xa '1, 2, 3 >> TO_NUMBER'
# 6

$ xa 'TO_NUMBER(NULL)'
# 0
```

## 加減算系演算子

加減算系演算子は加減算に類する動作を行う演算子で構成されます。

加減算系演算子は左優先結合です。

### `number + number`: 加算

加算演算子は、2つの値を加算します。

```shell
$ xa '1 + 2'
# 3
```

---

加算演算子は左辺の型によって異なる働きをします。

| 左辺の型   | 動作                                  |
|--------|-------------------------------------|
| 数値     | 左辺と右辺の和を返す                          |
| 文字列    | 左辺と右辺を連結した文字列を返す                    |
| 配列     | 左辺と右辺を連結した配列を生成する                   |
| オブジェクト | 左辺のオブジェクトに右辺の各エントリーを代入したオブジェクトを生成する |

#### 加算演算のオーバーライド

加算メソッド `_+_` を実装することで、オブジェクトの加算演算をカスタマイズできます。

```shell
$ xa '
  Obj := {
    `_+_`: this, other -> this.value + other.value
  }

  Obj{value: 100} + Obj{value: 23}
'
# 123
```

### `number - number`: 減算

減算演算子は、2つの値を減算します。

```shell
$ xa '3 - 1'
# 2
```

---

減算演算子も加算演算子と同様、オーバーライドができます。

```shell
$ xa '
  Obj := {
    `_-_`: this, other -> this.value - other.value
  }

  Obj{value: 123} - Obj{value: 23}
'
# 100
```

## 乗除算系演算子

乗除算系演算子は乗除算に類する動作を行う演算子で構成されます。

乗除算系演算子は左優先結合です。

### `number * number`: 乗算

乗算演算子は、2つの値を乗算します。

```shell
$ xa '2 * 3'
# 6
```

---

文字列の乗算はその文字列を繰り返します。

```shell
$ xa '"abc" * 3'
# abcabcabc
```

---

配列の乗算はその配列を繰り返します。

```shell
$ xa '[1, 2, 3] * 3'
# [1;2;3;1;2;3;1;2;3]
```

### `number / number`: 除算

除算演算子は、2つの値を除算します。

```shell
$ xa '6 / 3'
# 2.0
```

---

整数同士の除算でも、結果は浮動小数点数で返されます。

```shell
$ xa '7 / 4'
# 1.75
```

### `number % number`: 剰余

剰余演算子は、2つの値を除算し、その余りを返します。

```shell
$ xa '7 % 4'
# 3
```

---

小数も扱うことができます。

```shell
$ xa '1.75 % 0.5'
# 0.25
```

### `integer %% integer`: 整除性

左辺の値が右辺の値で割り切れるかどうかを返します。

```shell
$ xa '7 %% 4'
# FALSE
```

---

小数も扱うことができます。

```shell
$ xa '1.5 %% 0.5'
# TRUE

$ xa '1.75 %% 0.5'
# FALSE
```

### `integer !%% integer`: 否定整除性

左辺の値が右辺の値で割り切れないかどうかを返します。

この演算子は整除性演算子の否定 `!(integer %% integer)` と等価です。

```shell
$ xa '7 !%% 4'
# TRUE
```

## べき乗系演算子

べき乗系演算子はべき乗演算子のみで構成されます。

べき乗系演算子は右優先結合です。

### `number ^ number`: べき乗

べき乗演算子は、左辺の値を右辺の値で累乗します。

整数の整数乗の結果も浮動小数点数で返されます。

```shell
$ xa '2 ^ 3'
# 8.0
```

---

同じことができる関数 `POW` もあります。

```shell
$ xa 'POW(2; 3)'
# 8.0
```

## インクリメント・デクリメント

インクリメント `formula++` とデクリメント `formula--` は式に1を加減算して代入する演算子です。

```shell
$ xa '
  a := 10
  a++
  a
'
# 11

$ xa '
  a := 10
  a--
  a
'
# 9
```

---

インクリメント・デクリメントは、式の値を評価し、1を加減算して、その結果を元の式に代入する操作と等価です。

### 後置版と前置版

インクリメント・デクリメント演算子には後置版のほかに、前置版 `++formula` `--formula` もあります。

後置版は加減算前の値を返し、前置版は加減算後の値を返します。

```shell
$ xa '
  a := 10
  a++
'
# 10

$ xa '
  a := 10
  ++a
'
# 11
```

可読性の観点から、後置版が使われる頻度が高いです。

### 後置版前置版インクリメント・デクリメント

「前置版」インクリメント・デクリメントには、「後置版前置版」インクリメント・デクリメント `formula.++` `formula.--` が存在します。

それは他の前置演算子の後置版と同様、前置演算子を後置表現として記述するためのシンタックスシュガーです。

すなわちその挙動は「前置版」と等しく、加減算後の値を返します。

```shell
$ xa '
  a := 10
  a.++
'
# 11
```

### 数値以外のインクリメント

`formula++` の挙動は概ね以下の疑似コードと同じです。

```
old = get(formula)
new = plus(old, 1)
set(formula, new)
return old
```

---

実は `formula` が代入をサポートし、かつ整数 `1` との加減算が定義されていれば、数値以外の型でもインクリメント・デクリメントが可能です。

```shell
$ xa '
  s := "abc"
  s++
  s
'
# abc1
```

### インクリメント・デクリメントのオーバーライド

インクリメント・デクリメント演算子の挙動をカスタマイズできます。

#### 後置インクリメント `_++`

後置インクリメント `formula++` は `_++` メソッドでオーバーライドできます。

`_++` メソッドは引数なしで呼ばれ、新しい値を返します。

返された新しい値は `formula` に代入され、式の評価値としては古い値が返されます。

```shell
$ xa -q '
  Obj := {
    `_++`: this -> {value: this.value * 2}
  }
  obj := Obj{value: 100}
  result := obj++
  OUT << "result: " & result.value
  OUT << "obj: " & obj.value
'
# result: 100
# obj: 200
```

#### 前置インクリメント `++_`

前置インクリメント `++formula` は `++_` メソッドでオーバーライドできます。

`++_` メソッドは引数なしで呼ばれ、新しい値を返します。

返された新しい値は `formula` に代入され、式の評価値としてもその新しい値が返されます。

```shell
$ xa -q '
  Obj := {
    `++_`: this -> {value: this.value * 3}
  }
  obj := Obj{value: 100}
  result := ++obj
  OUT << "result: " & result.value
  OUT << "obj: " & obj.value
'
# result: 300
# obj: 300
```

#### フォールバック

`++_` メソッドが定義されていない場合、前置インクリメント `++formula` は `_++` メソッドにフォールバックします。

`_++` メソッドも定義されていない場合、`_+=_` メソッドにフォールバックします。このとき、右辺は整数 `1` で固定です。

`_+=_` メソッドも定義されていない場合、`_+_` メソッドにフォールバックして、その結果を `formula` に代入します。

デクリメントも同様に、`--_`、`_--`、`_-=_`、`_-_` の順にフォールバックします。

```shell
$ xa '
  # _++が無い場合、_+=_にフォールバック
  Obj := {
    `_+=_`: this, value -> {value: this.value + value * 10}
  }
  obj := Obj{value: 100}
  obj++
  obj.value
'
# 110
```

## 組み込み定数

数値系の組み込み定数です。

| 定数        | 意味    |
|-----------|-------|
| `MATH.PI` | 円周率   |
| `MATH.E`  | ネイピア数 |

## 組み込み関数

### `ABS`: 絶対値の取得

`ABS(value: NUMBER): NUMBER`

第1引数の絶対値を返します。

```shell
$ xa 'ABS(-10)'
# 10
```

### `FLOOR`: 小数点以下切り捨て

`FLOOR(number: NUMBER): INTEGER`

第1引数の数値を、値が小さい方の整数に丸めます。

```shell
$ xa 'FLOOR(1.5)'
# 1
```

### `DIV`: 除算の整数部

`DIV(x: NUMBER; y: NUMBER): NUMBER`

`x` を `y` で割り、その結果の整数部分を返します。

```shell
$ xa 'DIV(10; 3)'
# 3
```

### `SQRT`: 平方根の取得

`SQRT(number: NUMBER): NUMBER`

第1引数の正の平方根を返します。

```shell
$ xa '"$%.3f(  SQRT(100.0)  )"'
# 10.000
```

### `SIN`: 正弦

`SIN(number: NUMBER): NUMBER`

第1引数をラジアンとして解釈し、その正弦を返します。

```shell
$ xa '"$%.3f(  SIN(PI / 2)  )"'
# 1.000
```

### `COS`: 余弦

`COS(number: NUMBER): NUMBER`

第1引数をラジアンとして解釈し、その余弦を返します。

```shell
$ xa '"$%.3f(  COS(0)  )"'
# 1.000
```

### `TAN`: 正接

`TAN(number: NUMBER): NUMBER`

第1引数をラジアンとして解釈し、その正接を返します。

```shell
$ xa '"$%.3f(  TAN(PI / 4)  )"'
# 1.000
```

### `POW`: べき乗

`POW(base: NUMBER; exponent: NUMBER): NUMBER`

第1引数を第2引数でべき乗した結果を返します。

```shell
$ xa 'POW(2; 3)'
# 8.0
```

### `EXP`: 指数関数

`EXP(number: NUMBER): NUMBER`

第1引数の指数関数（底 e）を返します。

```shell
$ xa '"$%.3f(  EXP(1)  )"'
# 2.718

$ xa '"$%.3f(  EXP(2)  )"'
# 7.389
```

### `LOG`: 自然対数

`LOG(number: NUMBER): NUMBER`

第1引数の自然対数（底 e）を返します。

```shell
$ xa '"$%.3f(  LOG(MATH.E)  )"'
# 1.000
```

### `RAND`: 乱数の取得

`RAND(): DOUBLE`

`RAND([from: NUMBER; ]until: NUMBER): INT`

引数なしで呼び出された場合、0以上1未満の小数を返します。

1引数で呼び出された場合、0以上 `until` 未満の整数を返します。

2引数で呼び出された場合、`from` 以上 `until` 未満の整数を返します。
