name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

jobs:
  main:
    runs-on: ubuntu-latest
    steps:
      - name: リポジトリのチェックアウト（ビルド用）
        uses: actions/checkout@v4
        with:
          path: build-dir
          fetch-depth: 1

      - name: Javaのセットアップ
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin

      - name: Gradleキャッシュの設定
        uses: gradle/actions/setup-gradle@v4
        with:
          build-root-directory: build-dir

      - name: ビルド
        run: |
          cd build-dir
          bash gradlew clean build --stacktrace
        env:
          APP_VERSION: ${{ github.ref_name }}

      - name: Rubyのセットアップ
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: false

      - name: Jekyllのインストール
        run: |
          gem install jekyll bundler
          cd build-dir/docs
          bundle init
          bundle add jekyll
          bundle add webrick

      - name: Jekyllでドキュメントをビルド
        run: |
          cd build-dir/docs
          bundle exec jekyll build
        env:
          JEKYLL_ENV: production

      - name: ビルド済みドキュメントを配置
        run: |
          if [ ! -d build-dir/docs/_site ]; then
            echo "Error: Jekyll build failed - _site directory not found"
            exit 1
          fi
          tmp_list=$(mktemp)
          find build-dir/docs/_site -maxdepth 1 -mindepth 1 -print0 > "$tmp_list"
          conflict_found=0
          found_any=0
          while IFS= read -r -d '' path; do
            found_any=1
            name=$(basename "$path")
            if [ -e "build-dir/build/bundleRelease/$name" ]; then
              echo "Error: build output already contains $name - aborting to avoid overwrite"
              conflict_found=1
              break
            fi
          done < "$tmp_list"
          rm "$tmp_list"
          if [ "$found_any" -eq 0 ]; then
            echo "Error: Jekyll build produced no output"
            exit 1
          fi
          if [ "$conflict_found" -eq 1 ]; then
            exit 1
          fi
          # Jekyll生成のHTMLを最終出力に配置
          cp -r build-dir/docs/_site/. build-dir/build/bundleRelease/

      - name: リポジトリのチェックアウト（リリース用）
        uses: actions/checkout@v4
        with:
          path: release-dir
          ref: release
          fetch-depth: 1

      - name: ファイルの同期
        run: |
          mv release-dir/.git tmp92758927523654
          rsync -av --delete build-dir/build/bundleRelease/ release-dir/
          mv tmp92758927523654 release-dir/.git

      - name: コミット準備
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV
          echo "HASH=$(git -C build-dir rev-parse HEAD)" >> $GITHUB_ENV

      - name: コミット・リリース
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd release-dir
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit --allow-empty -m "v${{ env.VERSION }} - ${{ env.HASH }}"
          git push --force origin release

      - name: リリース用Zipの作成
        run: |
          cd build-dir/build/bundleRelease
          zip -r ../../../xarpite-release-${{ env.VERSION }}.zip .

      - name: GitHub Releaseにリリース
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: xarpite-release-${{ env.VERSION }}.zip

      - name: レポートをアップロード
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: build-dir/build/reports
          retention-days: 7
