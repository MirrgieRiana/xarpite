name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

jobs:
  main:
    runs-on: ubuntu-latest
    steps:
      - name: リポジトリのチェックアウト（ビルド用）
        uses: actions/checkout@v4
        with:
          path: build-dir
          fetch-depth: 1

      - name: Javaのセットアップ
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin

      - name: Gradleのセットアップ
        uses: gradle/actions/setup-gradle@v4
        with:
          build-root-directory: build-dir

      - name: Rubyのセットアップ
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: false

      - name: Jekyllのインストール
        run: |
          gem install jekyll bundler
          cd build-dir/pages
          bundle init
          bundle add jekyll
          bundle add jekyll-optional-front-matter
          bundle add webrick

      - name: バージョンの取得
        run: |
          set -e
          command -v kotlin > /dev/null || {
            echo "Kotlin runtime not available in PATH. Ensure Kotlin is installed." >&2
            exit 1
          }
          APP_VERSION=$(kotlin ./scripts/get-version.kts)
          echo "Derived APP_VERSION: ${APP_VERSION}"
          if [ -z "${APP_VERSION}" ]; then
            echo "APP_VERSION is empty" >&2
            exit 1
          fi
          echo "APP_VERSION=${APP_VERSION}" >> $GITHUB_ENV
        working-directory: build-dir

      - name: ビルド・Maven Publish
        run: |
          ./gradlew \
            clean \
            build \
            publishXarpiteBinPublicationToSonatypeRepository \
            closeAndReleaseSonatypeStagingRepository \
            --stacktrace

          ./scripts/build-pages.sh build/bundlePages

          echo "### $(pwd)"
          #find . -type f | sort
          echo "###"
        env:
          ORG_GRADLE_PROJECT_signingKey: ${{ secrets.SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingPassword: ${{ secrets.SIGNING_PASSWORD }}
          ORG_GRADLE_PROJECT_sonatypeUsername: ${{ secrets.SONATYPE_USERNAME }}
          ORG_GRADLE_PROJECT_sonatypePassword: ${{ secrets.SONATYPE_PASSWORD }}
        working-directory: build-dir

      - name: CHANGELOG.mdの編纂
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          ./scripts/make-changelog.sh "${{ env.APP_VERSION }}" || {
            echo "CHANGELOG.mdの編纂に失敗しました" >&2
            exit 1
          }

          if git diff --quiet && git diff --cached --quiet; then
            echo "CHANGELOG.mdに変更がありません"
          else
            echo "CHANGELOG.mdを更新します"
            git add CHANGELOG.md
            git add -u changelog.d/
            git commit -m "Update CHANGELOG.md for v${{ env.APP_VERSION }}"
            git push origin HEAD:main || {
              echo "CHANGELOG.mdのpushに失敗しました" >&2
              exit 1
            }
          fi
        working-directory: build-dir

      - name: リポジトリのチェックアウト（リリース用）
        uses: actions/checkout@v4
        with:
          path: release-dir
          ref: release
          fetch-depth: 1

      - name: ファイルの同期
        run: |
          mv release-dir/.git tmp92758927523654
          rsync -av --delete build-dir/build/bundleXarpiteBinAll/ release-dir/
          mv tmp92758927523654 release-dir/.git

      - name: コミット準備
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV
          echo "HASH=$(git -C build-dir rev-parse HEAD)" >> $GITHUB_ENV

      - name: コミット・リリース
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd release-dir
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit --allow-empty -m "v${{ env.VERSION }} - ${{ env.HASH }}"
          git push --force origin release

      - name: リリース用Zipの作成
        run: |
          (cd build-dir/build/bundlePages && zip -r ../../../xarpite-pages-${{ env.VERSION }}.zip .)
          (cd build-dir/build/bundleXarpiteBinAll && zip -r ../../../xarpite-bin-${{ env.VERSION }}-all.zip .)

      - name: GitHub Releaseにリリース
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            xarpite-pages-${{ env.VERSION }}.zip
            xarpite-bin-${{ env.VERSION }}-all.zip

      - name: レポートをアップロード
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: build-dir/build/reports
          retention-days: 7
