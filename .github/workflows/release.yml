name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

jobs:
  main:
    runs-on: ubuntu-latest
    steps:
      - name: リポジトリのチェックアウト（ビルド用）
        uses: actions/checkout@v4
        with:
          path: build-dir
          fetch-depth: 1

      - name: Javaのセットアップ
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin

      - name: Gradleのセットアップ
        uses: gradle/actions/setup-gradle@v4
        with:
          build-root-directory: build-dir

      - name: Rubyのセットアップ
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: false

      - name: Jekyllのインストール
        run: |
          gem install jekyll bundler
          cd build-dir/pages
          bundle init
          bundle add jekyll
          bundle add jekyll-optional-front-matter
          bundle add webrick

      - name: ビルド
        run: |
          ./gradlew clean build bundleRelease --stacktrace
          ./scripts/build-pages.sh build/bundleRelease

          echo "### $(pwd)"
          find -type f . | sort
          echo "###"
        env:
          APP_VERSION: ${{ github.ref_name }}
          ORG_GRADLE_PROJECT_signingKey: ${{ secrets.SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingPassword: ${{ secrets.SIGNING_PASSWORD }}
        working-directory: build-dir

      - name: リポジトリのチェックアウト（リリース用）
        uses: actions/checkout@v4
        with:
          path: release-dir
          ref: release
          fetch-depth: 1

      - name: ファイルの同期
        run: |
          mv release-dir/.git tmp92758927523654
          rsync -av --delete build-dir/build/bundleRelease/ release-dir/
          mv tmp92758927523654 release-dir/.git

      - name: コミット準備
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV
          echo "HASH=$(git -C build-dir rev-parse HEAD)" >> $GITHUB_ENV

      - name: コミット・リリース
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd release-dir
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit --allow-empty -m "v${{ env.VERSION }} - ${{ env.HASH }}"
          git push --force origin release

      - name: リリース用Zipの作成
        run: |
          cd build-dir/build/bundleRelease
          zip -r ../../../xarpite-release-${{ env.VERSION }}.zip .

      - name: GitHub Releaseにリリース
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: xarpite-release-${{ env.VERSION }}.zip

      - name: レポートをアップロード
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: build-dir/build/reports
          retention-days: 7
