{"version":3,"sources":["../../../../../../src/jsMain/kotlin/mirrg/xarpite/js/node/JsNodeMain.kt","src/kotlin/util/Lazy.kt","common/src/generated/_Arrays.kt","src/kotlin/util/Result.kt","src/kotlin/coroutines/Continuation.kt","JsNodeMain.kt","../../../../../../src/jsMain/kotlin/mirrg/xarpite/js/node/JsNodeUtils.kt"],"sourcesContent":["package mirrg.xarpite.js.node\n\nimport kotlinx.coroutines.await\nimport kotlinx.coroutines.channels.ReceiveChannel\nimport kotlinx.coroutines.coroutineScope\nimport kotlinx.coroutines.flow.flow\nimport kotlinx.coroutines.flow.produceIn\nimport kotlinx.coroutines.suspendCancellableCoroutine\nimport mirrg.xarpite.IoContext\nimport mirrg.xarpite.cli.INB_MAX_BUFFER_SIZE\nimport mirrg.xarpite.cli.ShowUsage\nimport mirrg.xarpite.cli.ShowVersion\nimport mirrg.xarpite.cli.cliEval\nimport mirrg.xarpite.cli.parseArguments\nimport mirrg.xarpite.cli.showUsage\nimport mirrg.xarpite.cli.showVersion\nimport mirrg.xarpite.compilers.objects.FluoriteValue\nimport mirrg.xarpite.compilers.objects.toFluoriteString\nimport mirrg.xarpite.envGetter\nimport mirrg.xarpite.fileSystemGetter\nimport mirrg.xarpite.isWindowsImpl\nimport mirrg.xarpite.js.Object_keys\nimport mirrg.xarpite.js.createJsMounts\nimport mirrg.xarpite.js.scope\nimport mirrg.xarpite.readBytesFromStdinImpl\nimport mirrg.xarpite.readLineFromStdinImpl\nimport mirrg.xarpite.writeBytesToStderrImpl\nimport mirrg.xarpite.writeBytesToStdoutImpl\nimport okio.NodeJsFileSystem\nimport kotlin.coroutines.resume\nimport kotlin.coroutines.resumeWithException\nimport kotlin.js.Promise\nimport kotlin.math.min\n\nsuspend fun main() {\n    envGetter = {\n        val env = process.env\n        Object_keys(env).associateWith { env[it].unsafeCast<String>() }\n    }\n    fileSystemGetter = { NodeJsFileSystem }\n    isWindowsImpl = { process.platform === \"win32\" }\n    readLineFromStdinImpl = { readLineFromStdinIterator.receiveCatching().getOrNull() }\n    readBytesFromStdinImpl = { readBytesFromStdinIterator.receiveCatching().getOrNull() }\n    writeBytesToStdoutImpl = { bytes ->\n        val uint8Array = js(\"new Uint8Array(bytes.length)\")\n        var i = 0\n        while (i < bytes.size) {\n            uint8Array[i] = bytes[i].toUByte().toInt()\n            i++\n        }\n        suspendCancellableCoroutine { cont ->\n            process.stdout.write(uint8Array) { error ->\n                if (!cont.isActive) return@write\n                if (error == null) {\n                    cont.resume(Unit)\n                } else {\n                    cont.resumeWithException(error.unsafeCast<Throwable>())\n                }\n            }\n        }\n    }\n    writeBytesToStderrImpl = { bytes ->\n        val uint8Array = js(\"new Uint8Array(bytes.length)\")\n        var i = 0\n        while (i < bytes.size) {\n            uint8Array[i] = bytes[i].toUByte().toInt()\n            i++\n        }\n        suspendCancellableCoroutine { cont ->\n            process.stderr.write(uint8Array) { error ->\n                if (!cont.isActive) return@write\n                if (error == null) {\n                    cont.resume(Unit)\n                } else {\n                    cont.resumeWithException(error.unsafeCast<Throwable>())\n                }\n            }\n        }\n    }\n\n    val options = try {\n        parseArguments(process.argv.drop(2))\n    } catch (_: ShowUsage) {\n        showUsage()\n        return\n    } catch (_: ShowVersion) {\n        showVersion()\n        return\n    }\n    coroutineScope {\n        val ioContext = object : IoContext {\n            override fun getPwd(): String = process.cwd()\n            override suspend fun out(value: FluoriteValue) = println(value.toFluoriteString(null).value)\n            override suspend fun err(value: FluoriteValue) = writeBytesToStderr(\"${value.toFluoriteString(null).value}\\n\".encodeToByteArray())\n            override suspend fun readLineFromStdin() = mirrg.xarpite.readLineFromStdin()\n            override suspend fun readBytesFromStdin() = mirrg.xarpite.readBytesFromStdin()\n            override suspend fun writeBytesToStdout(bytes: ByteArray) = mirrg.xarpite.writeBytesToStdout(bytes)\n            override suspend fun writeBytesToStderr(bytes: ByteArray) = mirrg.xarpite.writeBytesToStderr(bytes)\n            override suspend fun executeProcess(process: String, args: List<String>, env: Map<String, String?>) = mirrg.xarpite.executeProcess(process, args, env)\n        }\n        cliEval(ioContext, options) {\n            createJsMounts()\n        }\n    }\n}\n\nval readLineFromStdinIterator: ReceiveChannel<String> by lazy {\n    flow {\n        process.stdin.setEncoding(\"utf8\")\n        val stringIterator = js(\"(function(x) { return x[Symbol.asyncIterator](); })\")(process.stdin)\n        val sb = StringBuilder()\n        var afterR = false\n        while (true) {\n            val result = stringIterator.next().unsafeCast<Promise<dynamic>>().await()\n            if (result.done) {\n                if (sb.isNotEmpty()) {\n                    emit(sb.toString())\n                    sb.clear()\n                }\n                break\n            }\n            val string = result.value.unsafeCast<String>()\n            var index = 0\n            while (index < string.length) {\n                if (afterR && string[index] == '\\n') {\n                    index++\n                    afterR = false\n                    continue\n                }\n                val r = string.indexOf('\\r', index)\n                val n = string.indexOf('\\n', index)\n                val lineEnd = if (r == -1) n else if (n == -1) r else minOf(r, n)\n                if (lineEnd == -1) {\n                    sb.append(string.substring(index))\n                    index = string.length\n                    afterR = false\n                } else {\n                    sb.append(string.substring(index, lineEnd))\n                    emit(sb.toString())\n                    sb.clear()\n                    index = lineEnd + 1\n                    afterR = string[lineEnd] == '\\r'\n                }\n            }\n        }\n    }.produceIn(scope)\n}\n\nval readBytesFromStdinIterator: ReceiveChannel<ByteArray> by lazy {\n    flow {\n        val bytesIterator = js(\"(function(x) { return x[Symbol.asyncIterator](); })\")(process.stdin)\n        while (true) {\n            val result = bytesIterator.next().unsafeCast<Promise<dynamic>>().await()\n            if (result.done) break\n            val buffer = result.value.unsafeCast<dynamic>()\n            val byteArray = ByteArray(buffer.length.unsafeCast<Int>()) { i -> buffer[i].unsafeCast<Byte>() }\n            if (byteArray.size <= INB_MAX_BUFFER_SIZE) {\n                emit(byteArray)\n            } else {\n                var offset = 0\n                while (offset < byteArray.size) {\n                    val chunkSize = min(INB_MAX_BUFFER_SIZE, byteArray.size - offset)\n                    emit(byteArray.copyOfRange(offset, offset + chunkSize))\n                    offset += chunkSize\n                }\n            }\n        }\n    }.produceIn(scope)\n}\n",null,null,null,null,null,"package mirrg.xarpite.js.node\n\nimport kotlin.js.Json\n\nexternal class Process {\n    val env: Json\n    val argv: Array<String>\n    val stdin: dynamic\n    val stdout: dynamic\n    val stderr: dynamic\n    val platform: String\n    fun cwd(): String\n}\n\nval process by lazy { js(\"process\").unsafeCast<Process>() }\n"],"ignoreList":[],"x_google_ignoreList":[],"names":["<get-readLineFromStdinIterator>","<get-readBytesFromStdinIterator>","main","$completion","<unused var>","options","readLineFromStdinIterator$delegate$lambda","invoke","doResume","x","readLineFromStdinIterator$delegate$lambda$slambda","readLineFromStdinIterator$delegate$lambda$slambda$lambda","readBytesFromStdinIterator$delegate$lambda","readBytesFromStdinIterator$delegate$lambda$slambda","readBytesFromStdinIterator$delegate$lambda$slambda$lambda","main$lambda","env","result","element","main$slambda","main$slambda$lambda","main$slambda$lambda$lambda","cancellable","<init>","getPwd","out","value","err","readLineFromStdin","readBytesFromStdin","writeBytesToStdout","bytes","writeBytesToStderr","executeProcess","process","args","$options","<init properties JsNodeMain.kt>","<get-process>","process$delegate$lambda","<init properties JsNodeUtils.kt>"],"mappings":"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"}