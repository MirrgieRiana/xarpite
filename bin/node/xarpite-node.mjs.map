{"version":3,"sources":["../../../../../../src/jsMain/kotlin/mirrg/xarpite/js/node/JsNodeMain.kt","src/kotlin/util/Lazy.kt","common/src/generated/_Arrays.kt","src/kotlin/util/Result.kt","src/kotlin/coroutines/Continuation.kt","JsNodeMain.kt","../../../../../../src/jsMain/kotlin/mirrg/xarpite/js/node/JsNodeUtils.kt"],"sourcesContent":["package mirrg.xarpite.js.node\n\nimport mirrg.xarpite.envGetter\nimport mirrg.xarpite.fileSystemGetter\nimport kotlinx.coroutines.await\nimport kotlinx.coroutines.channels.ReceiveChannel\nimport kotlinx.coroutines.coroutineScope\nimport kotlinx.coroutines.flow.flow\nimport kotlinx.coroutines.flow.produceIn\nimport kotlinx.coroutines.suspendCancellableCoroutine\nimport mirrg.xarpite.cli.INB_MAX_BUFFER_SIZE\nimport mirrg.xarpite.cli.ShowUsage\nimport mirrg.xarpite.cli.ShowVersion\nimport mirrg.xarpite.cli.cliEval\nimport mirrg.xarpite.cli.parseArguments\nimport mirrg.xarpite.cli.showUsage\nimport mirrg.xarpite.cli.showVersion\nimport mirrg.xarpite.js.Object_keys\nimport mirrg.xarpite.js.createJsMounts\nimport mirrg.xarpite.js.scope\nimport okio.NodeJsFileSystem\nimport mirrg.xarpite.readBytesFromStdinImpl\nimport mirrg.xarpite.readLineFromStdinImpl\nimport mirrg.xarpite.writeBytesToStderrImpl\nimport mirrg.xarpite.writeBytesToStdoutImpl\nimport kotlin.coroutines.resume\nimport kotlin.coroutines.resumeWithException\nimport kotlin.js.Promise\nimport kotlin.math.min\n\nsuspend fun main() {\n    envGetter = {\n        val env = process.env\n        Object_keys(env).associateWith { env[it].unsafeCast<String>() }\n    }\n    fileSystemGetter = { NodeJsFileSystem }\n    readLineFromStdinImpl = { readLineFromStdinIterator.receiveCatching().getOrNull() }\n    readBytesFromStdinImpl = { readBytesFromStdinIterator.receiveCatching().getOrNull() }\n    writeBytesToStdoutImpl = { bytes ->\n        val uint8Array = js(\"new Uint8Array(bytes.length)\")\n        var i = 0\n        while (i < bytes.size) {\n            uint8Array[i] = bytes[i].toUByte().toInt()\n            i++\n        }\n        suspendCancellableCoroutine { cont ->\n            process.stdout.write(uint8Array) { error ->\n                if (!cont.isActive) return@write\n                if (error == null) {\n                    cont.resume(Unit)\n                } else {\n                    cont.resumeWithException(error.unsafeCast<Throwable>())\n                }\n            }\n        }\n    }\n    writeBytesToStderrImpl = { bytes ->\n        val uint8Array = js(\"new Uint8Array(bytes.length)\")\n        var i = 0\n        while (i < bytes.size) {\n            uint8Array[i] = bytes[i].toUByte().toInt()\n            i++\n        }\n        suspendCancellableCoroutine { cont ->\n            process.stderr.write(uint8Array) { error ->\n                if (!cont.isActive) return@write\n                if (error == null) {\n                    cont.resume(Unit)\n                } else {\n                    cont.resumeWithException(error.unsafeCast<Throwable>())\n                }\n            }\n        }\n    }\n\n    val options = try {\n        parseArguments(process.argv.drop(2))\n    } catch (_: ShowUsage) {\n        showUsage()\n        return\n    } catch (_: ShowVersion) {\n        showVersion()\n        return\n    }\n    coroutineScope {\n        cliEval(options) {\n            createJsMounts()\n        }\n    }\n}\n\nval readLineFromStdinIterator: ReceiveChannel<String> by lazy {\n    flow {\n        process.stdin.setEncoding(\"utf8\")\n        val stringIterator = js(\"(function(x) { return x[Symbol.asyncIterator](); })\")(process.stdin)\n        val sb = StringBuilder()\n        var afterR = false\n        while (true) {\n            val result = stringIterator.next().unsafeCast<Promise<dynamic>>().await()\n            if (result.done) {\n                if (sb.isNotEmpty()) {\n                    emit(sb.toString())\n                    sb.clear()\n                }\n                break\n            }\n            val string = result.value.unsafeCast<String>()\n            var index = 0\n            while (index < string.length) {\n                if (afterR && string[index] == '\\n') {\n                    index++\n                    afterR = false\n                    continue\n                }\n                val r = string.indexOf('\\r', index)\n                val n = string.indexOf('\\n', index)\n                val lineEnd = if (r == -1) n else if (n == -1) r else minOf(r, n)\n                if (lineEnd == -1) {\n                    sb.append(string.substring(index))\n                    index = string.length\n                    afterR = false\n                } else {\n                    sb.append(string.substring(index, lineEnd))\n                    emit(sb.toString())\n                    sb.clear()\n                    index = lineEnd + 1\n                    afterR = string[lineEnd] == '\\r'\n                }\n            }\n        }\n    }.produceIn(scope)\n}\n\nval readBytesFromStdinIterator: ReceiveChannel<ByteArray> by lazy {\n    flow {\n        val bytesIterator = js(\"(function(x) { return x[Symbol.asyncIterator](); })\")(process.stdin)\n        while (true) {\n            val result = bytesIterator.next().unsafeCast<Promise<dynamic>>().await()\n            if (result.done) break\n            val buffer = result.value.unsafeCast<dynamic>()\n            val byteArray = ByteArray(buffer.length.unsafeCast<Int>()) { i -> buffer[i].unsafeCast<Byte>() }\n            if (byteArray.size <= INB_MAX_BUFFER_SIZE) {\n                emit(byteArray)\n            } else {\n                var offset = 0\n                while (offset < byteArray.size) {\n                    val chunkSize = min(INB_MAX_BUFFER_SIZE, byteArray.size - offset)\n                    emit(byteArray.copyOfRange(offset, offset + chunkSize))\n                    offset += chunkSize\n                }\n            }\n        }\n    }.produceIn(scope)\n}\n",null,null,null,null,null,"package mirrg.xarpite.js.node\n\nimport kotlin.js.Json\n\nexternal class Process {\n    val env: Json\n    val argv: Array<String>\n    val stdin: dynamic\n    val stdout: dynamic\n    val stderr: dynamic\n}\n\nval process by lazy { js(\"process\").unsafeCast<Process>() }\n"],"ignoreList":[],"x_google_ignoreList":[],"names":["<get-readLineFromStdinIterator>","<get-readBytesFromStdinIterator>","main","$completion","<unused var>","options","readLineFromStdinIterator$delegate$lambda","invoke","doResume","x","readLineFromStdinIterator$delegate$lambda$slambda","readLineFromStdinIterator$delegate$lambda$slambda$lambda","readBytesFromStdinIterator$delegate$lambda","readBytesFromStdinIterator$delegate$lambda$slambda","readBytesFromStdinIterator$delegate$lambda$slambda$lambda","main$lambda","env","result","element","main$slambda","main$slambda$lambda","main$slambda$lambda$lambda","cancellable","$options","<init properties JsNodeMain.kt>","<get-process>","process$delegate$lambda","<init properties JsNodeUtils.kt>"],"mappings":"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"}