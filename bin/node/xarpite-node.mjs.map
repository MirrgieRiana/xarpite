{"version":3,"sources":["../../../../../../src/jsMain/kotlin/mirrg/xarpite/js/node/JsNodeMain.kt","src/kotlin/util/Lazy.kt","common/src/generated/_Arrays.kt","src/kotlin/util/Result.kt","src/kotlin/coroutines/Continuation.kt","JsNodeMain.kt","../../../../../../src/jsMain/kotlin/mirrg/xarpite/js/node/JsNodeUtils.kt"],"sourcesContent":["package mirrg.xarpite.js.node\n\nimport envGetter\nimport fileSystemGetter\nimport kotlinx.coroutines.CoroutineScope\nimport kotlinx.coroutines.SupervisorJob\nimport kotlinx.coroutines.await\nimport kotlinx.coroutines.cancel\nimport kotlinx.coroutines.channels.ReceiveChannel\nimport kotlinx.coroutines.coroutineScope\nimport kotlinx.coroutines.flow.flow\nimport kotlinx.coroutines.flow.produceIn\nimport kotlinx.coroutines.suspendCancellableCoroutine\nimport mirrg.xarpite.cli.INB_MAX_BUFFER_SIZE\nimport mirrg.xarpite.cli.ShowUsage\nimport mirrg.xarpite.cli.ShowVersion\nimport mirrg.xarpite.cli.main\nimport mirrg.xarpite.cli.parseArguments\nimport mirrg.xarpite.cli.showUsage\nimport mirrg.xarpite.cli.showVersion\nimport mirrg.xarpite.js.Object_keys\nimport mirrg.xarpite.js.createJsMounts\nimport mirrg.xarpite.js.scope\nimport okio.NodeJsFileSystem\nimport readBytesFromStdinImpl\nimport readLineFromStdinImpl\nimport writeBytesToStdoutImpl\nimport kotlin.coroutines.resume\nimport kotlin.coroutines.resumeWithException\nimport kotlin.js.Promise\nimport kotlin.math.min\n\nsuspend fun main() {\n    envGetter = {\n        val env = process.env\n        Object_keys(env).associateWith { env[it].unsafeCast<String>() }\n    }\n    fileSystemGetter = { NodeJsFileSystem }\n    readLineFromStdinImpl = { readLineFromStdinIterator.receiveCatching().getOrNull() }\n    readBytesFromStdinImpl = { readBytesFromStdinIterator.receiveCatching().getOrNull() }\n    writeBytesToStdoutImpl = { bytes ->\n        val uint8Array = js(\"new Uint8Array(bytes.length)\")\n        var i = 0\n        while (i < bytes.size) {\n            uint8Array[i] = bytes[i].toUByte().toInt()\n            i++\n        }\n        suspendCancellableCoroutine { cont ->\n            process.stdout.write(uint8Array) { error ->\n                if (!cont.isActive) return@write\n                if (error == null) {\n                    cont.resume(Unit)\n                } else {\n                    cont.resumeWithException(error.unsafeCast<Throwable>())\n                }\n            }\n        }\n    }\n\n    val options = try {\n        parseArguments(process.argv.drop(2))\n    } catch (_: ShowUsage) {\n        showUsage()\n        return\n    } catch (_: ShowVersion) {\n        showVersion()\n        return\n    }\n    coroutineScope {\n        val daemonScope = CoroutineScope(coroutineContext + SupervisorJob())\n        try {\n            coroutineScope {\n                main(options, this, daemonScope) {\n                    createJsMounts()\n                }\n            }\n        } finally {\n            daemonScope.cancel()\n        }\n    }\n}\n\nval readLineFromStdinIterator: ReceiveChannel<String> by lazy {\n    flow {\n        process.stdin.setEncoding(\"utf8\")\n        val stringIterator = js(\"(function(x) { return x[Symbol.asyncIterator](); })\")(process.stdin)\n        val sb = StringBuilder()\n        var afterR = false\n        while (true) {\n            val result = stringIterator.next().unsafeCast<Promise<dynamic>>().await()\n            if (result.done) {\n                if (sb.isNotEmpty()) {\n                    emit(sb.toString())\n                    sb.clear()\n                }\n                break\n            }\n            val string = result.value.unsafeCast<String>()\n            var index = 0\n            while (index < string.length) {\n                if (afterR && string[index] == '\\n') {\n                    index++\n                    afterR = false\n                    continue\n                }\n                val r = string.indexOf('\\r', index)\n                val n = string.indexOf('\\n', index)\n                val lineEnd = if (r == -1) n else if (n == -1) r else minOf(r, n)\n                if (lineEnd == -1) {\n                    sb.append(string.substring(index))\n                    index = string.length\n                    afterR = false\n                } else {\n                    sb.append(string.substring(index, lineEnd))\n                    emit(sb.toString())\n                    sb.clear()\n                    index = lineEnd + 1\n                    afterR = string[lineEnd] == '\\r'\n                }\n            }\n        }\n    }.produceIn(scope)\n}\n\nval readBytesFromStdinIterator: ReceiveChannel<ByteArray> by lazy {\n    flow {\n        val bytesIterator = js(\"(function(x) { return x[Symbol.asyncIterator](); })\")(process.stdin)\n        while (true) {\n            val result = bytesIterator.next().unsafeCast<Promise<dynamic>>().await()\n            if (result.done) break\n            val buffer = result.value.unsafeCast<dynamic>()\n            val byteArray = ByteArray(buffer.length.unsafeCast<Int>()) { i -> buffer[i].unsafeCast<Byte>() }\n            if (byteArray.size <= INB_MAX_BUFFER_SIZE) {\n                emit(byteArray)\n            } else {\n                var offset = 0\n                while (offset < byteArray.size) {\n                    val chunkSize = min(INB_MAX_BUFFER_SIZE, byteArray.size - offset)\n                    emit(byteArray.copyOfRange(offset, offset + chunkSize))\n                    offset += chunkSize\n                }\n            }\n        }\n    }.produceIn(scope)\n}\n",null,null,null,null,null,"package mirrg.xarpite.js.node\n\nimport kotlin.js.Json\n\nexternal class Process {\n    val env: Json\n    val argv: Array<String>\n    val stdin: dynamic\n    val stdout: dynamic\n}\n\nval process by lazy { js(\"process\").unsafeCast<Process>() }\n"],"ignoreList":[],"x_google_ignoreList":[],"names":["<get-readLineFromStdinIterator>","<get-readBytesFromStdinIterator>","main","$completion","<unused var>","options","readLineFromStdinIterator$delegate$lambda","invoke","doResume","x","readLineFromStdinIterator$delegate$lambda$slambda","readLineFromStdinIterator$delegate$lambda$slambda$lambda","readBytesFromStdinIterator$delegate$lambda","readBytesFromStdinIterator$delegate$lambda$slambda","readBytesFromStdinIterator$delegate$lambda$slambda$lambda","main$lambda","env","result","element","main$slambda","main$slambda$lambda","main$slambda$lambda$lambda","cancellable","main$slambda$slambda$lambda","$options","$daemonScope","main$slambda$slambda","t","<init properties JsNodeMain.kt>","<get-process>","process$delegate$lambda","<init properties JsNodeUtils.kt>"],"mappings":"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"}